/*
 * menu_nes_fds.c
 *
 *  Created on: 31/mar/2012
 *      Author: fhorse
 */

#include "menu_nes_fds.h"
#include "fds.h"
#include "text.h"

#if defined (__SUNPRO_C)
#pragma align 4 (my_pixbuf)
#endif
#if defined (__GNUC__)
static const guint8 eject_icon_inline[] __attribute__ ((__aligned__ (4))) =
#else
static const guint8 eject_icon_inline[] =
#endif
{ ""
  /* Pixbuf magic (0x47646b50) */
  "GdkP"
  /* length: header (24) + pixel_data (928) */
  "\0\0\3\270"
  /* pixdata_type (0x2010002) */
  "\2\1\0\2"
  /* rowstride (64) */
  "\0\0\0@"
  /* width (16) */
  "\0\0\0\20"
  /* height (16) */
  "\0\0\0\20"
  /* pixel_data: */
  "\204\377\377\377\0\3E\227\377\32E\227\3775E\227\377J\202E\227\377Y\3"
  "E\227\377JE\227\3775E\227\377\32\206\377\377\377\0\14E\227\377\14E\227"
  "\3774z\257\361k\256\306\343\225\310\320\333\305\323\325\327\355\322\324"
  "\326\355\304\315\330\305\252\301\337\225w\253\356kE\227\3774E\227\377"
  "\14\203\377\377\377\0\6E\227\377\14E\227\377=\250\303\346\201\322\327"
  "\335\331\350\354\361\377\363\366\372\377\202\373\375\376\377\6\362\365"
  "\371\377\345\351\356\377\307\315\324\331\237\272\335\201E\227\377=E\227"
  "\377\14\202\377\377\377\0)E\227\3774\250\303\346\201\324\330\336\363"
  "\367\370\373\377\377\377\377\377\366\371\374\377\356\363\372\377\355"
  "\363\372\377\364\370\374\377\377\377\377\377\363\366\371\377\304\312"
  "\321\363\234\267\332\201E\227\3774\377\377\377\0E\227\377\32z\257\361"
  "k\322\327\335\331\367\370\373\377\377\377\377\377\353\361\371\377\351"
  "\360\371\377\343\354\367\377\354\362\372\377\346\357\370\377\345\356"
  "\370\377\377\377\377\377\363\366\371\377\272\277\307\331p\245\350kE\227"
  "\377\32E\227\3775\256\305\342\225\350\354\361\377\377\377\377\377\353"
  "\361\371\377\351\360\371\377\332\345\365\377X\213\313\377S\204\301\377"
  "\351\360\371\377\202\343\354\367\377\33\377\377\377\377\330\337\347\377"
  "\224\253\310\225E\227\3775E\227\377J\307\317\332\305\363\366\372\377"
  "\364\370\374\377\350\357\371\377\337\351\366\377S\204\301\377R\203\301"
  "\377U\207\310\377R\203\300\377\350\357\371\377\341\353\367\377\361\365"
  "\373\377\352\357\366\377\240\251\264\305E\227\377JE\227\377Y\321\323"
  "\325\355\373\375\376\377\354\362\372\377\350\357\371\377T\205\305\377"
  "R\203\301\377\202R\203\300\377\6U\206\306\377R\201\276\377\345\356\370"
  "\377\343\354\367\377\371\373\375\377\245\247\251\355\202E\227\377Y\5"
  "\320\322\324\355\373\375\376\377\353\361\371\377\345\356\370\377\344"
  "\355\367\377\202\343\354\367\377\2\341\353\367\377\337\351\366\377\202"
  "\335\350\366\377\12\341\353\367\377\361\365\372\377\240\242\244\355E"
  "\227\377YE\227\377J\302\313\326\305\357\363\370\377\362\366\373\377\343"
  "\354\367\377R\203\300\377\202R\201\276\377\202Q\200\275\377\33W\212\312"
  "\377\334\347\365\377\356\363\372\377\333\344\357\377\224\234\247\305"
  "E\227\377JE\227\3775\247\276\334\225\341\345\354\377\376\376\377\377"
  "\341\353\367\377Z\216\320\377[\217\321\377Y\215\317\377[\217\321\377"
  "Y\215\317\377Z\216\320\377\332\345\365\377\372\374\376\377\277\311\326"
  "\377\201\230\266\225E\227\3775E\227\377\32s\250\353k\276\303\312\331"
  "\355\361\367\377\377\377\377\377\202\335\350\366\377\30\334\347\365\377"
  "\333\346\365\377\332\345\365\377\330\345\364\377\376\376\377\377\334"
  "\344\357\377\222\232\243\331c\230\333kE\227\377\32\377\377\377\0E\227"
  "\3774\224\260\322\201\263\273\303\363\350\356\364\377\376\376\377\377"
  "\357\364\373\377\341\353\367\377\340\352\366\377\355\363\372\377\372"
  "\374\376\377\333\344\356\377\221\234\250\363y\224\267\201E\227\3774\202"
  "\377\377\377\0\16E\227\377\14E\227\377=\214\247\312\201\243\253\263\331"
  "\310\321\334\377\341\350\361\377\362\366\373\377\356\363\372\377\326"
  "\340\355\377\270\303\322\377\214\224\237\331w\222\265\201E\227\377=E"
  "\227\377\14\203\377\377\377\0\14E\227\377\14E\227\3774h\235\340k\203"
  "\233\270\225\216\227\242\305\224\226\230\355\220\222\225\355\210\221"
  "\234\305y\221\256\225`\225\330kE\227\3774E\227\377\14\206\377\377\377"
  "\0\3E\227\377\32E\227\3775E\227\377J\202E\227\377Y\3E\227\377JE\227\377"
  "5E\227\377\32\204\377\377\377\0"};

#if defined (__SUNPRO_C)
#pragma align 4 (my_pixbuf)
#endif
#if defined (__GNUC__)
static const guint8 disk_side_icon_inline[] __attribute__ ((__aligned__ (4))) =
#else
static const guint8 disk_side_icon_inline[] =
#endif
{ ""
  /* Pixbuf magic (0x47646b50) */
  "GdkP"
  /* length: header (24) + pixel_data (789) */
  "\0\0\3-"
  /* pixdata_type (0x2010002) */
  "\2\1\0\2"
  /* rowstride (64) */
  "\0\0\0@"
  /* width (16) */
  "\0\0\0\20"
  /* height (16) */
  "\0\0\0\20"
  /* pixel_data: */
  "\242\377\377\377\0\14\330\330\330\275\325\325\325\377\322\322\322\377"
  "\316\316\316\377\311\311\311\377\304\304\304\377\277\277\277\377\271"
  "\271\271\377\263\263\263\377\255\255\255\377\246\246\246\377\240\240"
  "\240\275\203\377\377\377\0\3\330\330\330\77\336\336\336\377\363\363\363"
  "\377\205\355\355\355\377\203\354\354\354\377\3\361\361\361\377\261\261"
  "\261\377\222\222\222B\202\377\377\377\0\3\324\324\324\275\350\350\350"
  "\377\333\333\333\377\202\342\342\342\377\1\341\341\341\377\203\340\340"
  "\340\377\32\337\337\337\377\303\303\303\377\321\321\321\377\322\322\322"
  "\377\212\212\212\275\377\377\377\0\323\323\323\77\331\331\331\377\354"
  "\354\354\377\336\336\336\377\330\330\330\377\322\322\322\377\314\314"
  "\314\377\310\310\310\377\307\307\307\377\310\310\310\377\313\313\313"
  "\377\320\320\320\377\335\335\335\377\350\350\350\377\240\240\240\377"
  "|||B\317\317\317\275\350\350\350\377\347\347\347\377\341\341\341\377"
  "\202\340\340\340\377\24n\227\324\377{\236\324\377q\230\320\377\202\244"
  "\326\377h\216\315\377i\220\315\377u\232\320\377s\231\321\377b\213\310"
  "\377^n\204\313\311\311\311\275\335\335\335\377\310\310\310\377\301\301"
  "\301\377\300\300\300\377\276\276\276\377e\215\314\377\260\315\363\377"
  "\377\377\377\377\263\307\343\377\204\377\377\377\377\14\241\277\352\377"
  "`\211\311\377\303\303\303\377\335\335\335\377\302\302\302\377\276\276"
  "\276\377\221\221\221\377\222\222\222\377[\206\307\377\236\300\357\377"
  "\377\377\377\377n\223\314\377\202\377\377\377\377D\367\373\377\377\361"
  "\370\377\377\214\257\344\377a\212\307\377\274\274\274\377\331\331\331"
  "\377\276\276\276\377\273\273\273\377\216\216\216\377\217\217\217\377"
  "]\210\310\377\241\277\357\377\372\374\375\377\373\374\376\377\375\375"
  "\376\377\374\375\376\377\372\373\375\377\373\374\375\377\205\250\335"
  "\377S\177\301\377\265\265\265\377\326\326\326\377\273\273\273\377\271"
  "\271\271\377\266\266\266\377\264\264\264\377e\215\312\377\231\270\352"
  "\377~\245\335\377\200\246\335\377|\243\333\377z\240\331\377y\240\331"
  "\377x\237\330\377x\236\330\377]\204\277\377\256\256\256\377\351\351\351"
  "\377\323\323\323\377\322\322\322\377\321\321\321\377\320\320\320\377"
  "a\213\311\377\222\265\346\377\201\247\342\377\201\247\341\377}\243\336"
  "\377{\241\334\377y\237\333\377w\236\331\377s\232\324\377W~\273\377\246"
  "\246\246\267\240\240\240\377\232\232\232\377\223\223\223\377\215\215"
  "\215\377\206\206\206\377T\201\304\377\227\266\352\377\352\363\363\377"
  "\346\361\355\377\346\361\357\377\346\360\357\377\345\361\355\377\355"
  "\365\363\377y\234\325\377Dp\260\377\206\377\377\377\0\12Q\177\303\377"
  "\232\266\357\377\350\363\352\377\204\277Q\377\230\311o\377\231\311q\377"
  "\204\277T\377\351\364\344\377{\234\335\377:i\252\377\206\377\377\377"
  "\0\12U\203\306\377\272\316\357\377\377\377\335\377\307\356\207\377\327"
  "\364\242\377\327\366\242\377\307\356\214\377\377\377\340\377\205\242"
  "\335\377>j\253\377\206\377\377\377\0\12""3h\272\305X\204\303\377h\213"
  "\323\377p\217\341\377l\215\334\377m\213\332\377n\212\327\377l\213\315"
  "\377Dm\253\377._\246\377"};

#if defined (__SUNPRO_C)
#pragma align 4 (my_pixbuf)
#endif
#if defined (__GNUC__)
static const guint8 switch_icon_inline[] __attribute__ ((__aligned__ (4))) =
#else
static const guint8 switch_icon_inline[] =
#endif
{ ""
  /* Pixbuf magic (0x47646b50) */
  "GdkP"
  /* length: header (24) + pixel_data (930) */
  "\0\0\3\272"
  /* pixdata_type (0x2010002) */
  "\2\1\0\2"
  /* rowstride (64) */
  "\0\0\0@"
  /* width (16) */
  "\0\0\0\20"
  /* height (16) */
  "\0\0\0\20"
  /* pixel_data: */
  "\204\377\377\377\0\3E\227\377\32E\227\3775E\227\377J\202E\227\377Y\3"
  "E\227\377JE\227\3775E\227\377\32\206\377\377\377\0\14E\227\377\14E\227"
  "\3774z\257\361k\256\306\343\225\310\320\333\305\323\325\327\355\322\324"
  "\326\355\304\315\330\305\252\301\337\225w\253\356kE\227\3774E\227\377"
  "\14\203\377\377\377\0\6E\227\377\14E\227\377=\250\303\346\201\322\327"
  "\335\331\350\354\361\377\363\366\372\377\202\373\375\376\377\6\362\365"
  "\371\377\345\351\356\377\307\315\324\331\237\272\335\201E\227\377=E\227"
  "\377\14\202\377\377\377\0\26E\227\3774\250\303\346\201\324\330\336\363"
  "\367\370\373\377\377\377\377\377\366\371\374\377\356\363\372\377\355"
  "\363\372\377\364\370\374\377\377\377\377\377\363\366\371\377\304\312"
  "\321\363\234\267\332\201E\227\3774\377\377\377\0E\227\377\32z\257\361"
  "k\322\327\335\331\367\370\373\377\377\377\377\377\353\361\371\377\351"
  "\360\371\377\202\350\357\371\377\14\346\357\370\377\345\356\370\377\377"
  "\377\377\377\363\366\371\377\272\277\307\331p\245\350kE\227\377\32E\227"
  "\3775\256\305\342\225\350\354\361\377\377\377\377\377\235\274\344\377"
  "\203T\205\303\377\202S\204\301\377%R\203\300\377z\244\332\377\377\377"
  "\377\377\330\337\347\377\224\253\310\225E\227\3775E\227\377J\307\317"
  "\332\305\363\366\372\377\364\370\374\377T\205\303\377\276\323\355\377"
  "\346\357\370\377\345\356\370\377\344\355\367\377\343\354\367\377\273"
  "\320\354\377R\201\276\377\361\365\373\377\352\357\366\377\240\251\264"
  "\305E\227\377JE\227\377Y\321\323\325\355\373\375\376\377\354\362\372"
  "\377T\205\303\377\345\356\370\377\344\355\367\377\343\354\367\377\337"
  "\351\366\377o\235\327\377\325\343\363\377Q\200\275\377\343\354\367\377"
  "\371\373\375\377\245\247\251\355\202E\227\377Y4\320\322\324\355\373\375"
  "\376\377\353\361\371\377S\204\301\377\274\321\354\377\343\354\367\377"
  "\334\347\365\377o\235\327\377Q\177\273\377\254\307\350\377Q\200\275\377"
  "\341\353\367\377\361\365\372\377\240\242\244\355E\227\377YE\227\377J"
  "\302\313\326\305\357\363\370\377\362\366\373\377\227\271\342\377It\252"
  "\377\341\353\367\377\243\300\345\377Q\177\273\377P~\271\377N|\266\377"
  "u\241\330\377\356\363\372\377\333\344\357\377\224\234\247\305E\227\377"
  "JE\227\3775\247\276\334\225\341\345\354\377\376\376\377\377\341\353\367"
  "\377\340\352\366\377\337\351\366\377\335\350\366\377\213\260\337\377"
  "P~\271\377\320\337\362\377\332\345\365\377\372\374\376\377\277\311\326"
  "\377\201\230\266\225E\227\3775E\227\377\32s\250\353k\276\303\312\331"
  "\355\361\367\377\377\377\377\377\202\335\350\366\377\30\334\347\365\377"
  "\333\346\365\377\210\256\336\377\316\335\361\377\376\376\377\377\334"
  "\344\357\377\222\232\243\331c\230\333kE\227\377\32\377\377\377\0E\227"
  "\3774\224\260\322\201\263\273\303\363\350\356\364\377\376\376\377\377"
  "\357\364\373\377\341\353\367\377\340\352\366\377\355\363\372\377\372"
  "\374\376\377\333\344\356\377\221\234\250\363y\224\267\201E\227\3774\202"
  "\377\377\377\0\16E\227\377\14E\227\377=\214\247\312\201\243\253\263\331"
  "\310\321\334\377\341\350\361\377\362\366\373\377\356\363\372\377\326"
  "\340\355\377\270\303\322\377\214\224\237\331w\222\265\201E\227\377=E"
  "\227\377\14\203\377\377\377\0\14E\227\377\14E\227\3774h\235\340k\203"
  "\233\270\225\216\227\242\305\224\226\230\355\220\222\225\355\210\221"
  "\234\305y\221\256\225`\225\330kE\227\3774E\227\377\14\206\377\377\377"
  "\0\3E\227\377\32E\227\3775E\227\377J\202E\227\377Y\3E\227\377JE\227\377"
  "5E\227\377\32\204\377\377\377\0"};

enum {
	MEJECT,
	MSIDES,
	MSIDE0,
	MSIDE1,
	MSIDE2,
	MSIDE3,
	MSIDE4,
	MSIDE5,
	MSIDE6,
	MSIDE7,
	MSWITCH,
	NUMCHKS
};

static GtkWidget *check[NUMCHKS];

void menu_nes_fds(GtkWidget *mainmenu, GtkAccelGroup *accel_group) {
	GtkWidget *menu;

	menu = gtk_menu_new();
	check[MSIDES] = gtk_image_menu_item_new_with_mnemonic("_Disk side");
	check[MEJECT] = gtk_image_menu_item_new_with_mnemonic("Ej_ect/Insert disk");

	gtk_menu_item_set_submenu(GTK_MENU_ITEM(check[MSIDES]), menu);
	gtk_menu_shell_append(GTK_MENU_SHELL(mainmenu), check[MSIDES]);
	gtk_menu_shell_append(GTK_MENU_SHELL(mainmenu), check[MEJECT]);

	check[MSIDE0] = gtk_check_menu_item_new_with_mnemonic("Disk 1 side A");
	check[MSIDE1] = gtk_check_menu_item_new_with_mnemonic("Disk 1 side B");
	check[MSIDE2] = gtk_check_menu_item_new_with_mnemonic("Disk 2 side A");
	check[MSIDE3] = gtk_check_menu_item_new_with_mnemonic("Disk 2 side B");
	check[MSIDE4] = gtk_check_menu_item_new_with_mnemonic("Disk 3 side A");
	check[MSIDE5] = gtk_check_menu_item_new_with_mnemonic("Disk 3 side B");
	check[MSIDE6] = gtk_check_menu_item_new_with_mnemonic("Disk 4 side A");
	check[MSIDE7] = gtk_check_menu_item_new_with_mnemonic("Disk 4 side B");
	check[MSWITCH] = gtk_image_menu_item_new_with_mnemonic("_Switch sides");

	gw_image_from_inline(check[MSIDES], disk_side_icon_inline);
	gw_image_from_inline(check[MSWITCH], switch_icon_inline);
	gw_image_from_inline(check[MEJECT], eject_icon_inline);

	gtk_widget_add_accelerator(check[MEJECT], "activate", accel_group, GDK_e,
			GDK_MOD1_MASK, GTK_ACCEL_VISIBLE);
	gtk_widget_add_accelerator(check[MSWITCH], "activate", accel_group, GDK_s,
			GDK_MOD1_MASK, GTK_ACCEL_VISIBLE);

	gtk_menu_shell_append(GTK_MENU_SHELL(menu), check[MSIDE0]);
	gtk_menu_shell_append(GTK_MENU_SHELL(menu), check[MSIDE1]);
	gtk_menu_shell_append(GTK_MENU_SHELL(menu), check[MSIDE2]);
	gtk_menu_shell_append(GTK_MENU_SHELL(menu), check[MSIDE3]);
	gtk_menu_shell_append(GTK_MENU_SHELL(menu), check[MSIDE4]);
	gtk_menu_shell_append(GTK_MENU_SHELL(menu), check[MSIDE5]);
	gtk_menu_shell_append(GTK_MENU_SHELL(menu), check[MSIDE6]);
	gtk_menu_shell_append(GTK_MENU_SHELL(menu), check[MSIDE7]);
	gtk_menu_shell_append(GTK_MENU_SHELL(menu), gtk_separator_menu_item_new());
	gtk_menu_shell_append(GTK_MENU_SHELL(menu), check[MSWITCH]);

	g_signal_connect_swapped(G_OBJECT(check[MEJECT]), "activate",
	        G_CALLBACK(menu_nes_fds_eject_insert_disk), NULL);
	g_signal_connect_swapped(G_OBJECT(check[MSIDE0]), "activate",
	        G_CALLBACK(menu_nes_fds_select_side), GINT_TO_POINTER(0));
	g_signal_connect_swapped(G_OBJECT(check[MSIDE1]), "activate",
	        G_CALLBACK(menu_nes_fds_select_side), GINT_TO_POINTER(1));
	g_signal_connect_swapped(G_OBJECT(check[MSIDE2]), "activate",
	        G_CALLBACK(menu_nes_fds_select_side), GINT_TO_POINTER(2));
	g_signal_connect_swapped(G_OBJECT(check[MSIDE3]), "activate",
	        G_CALLBACK(menu_nes_fds_select_side), GINT_TO_POINTER(3));
	g_signal_connect_swapped(G_OBJECT(check[MSIDE4]), "activate",
	        G_CALLBACK(menu_nes_fds_select_side), GINT_TO_POINTER(4));
	g_signal_connect_swapped(G_OBJECT(check[MSIDE5]), "activate",
	        G_CALLBACK(menu_nes_fds_select_side), GINT_TO_POINTER(5));
	g_signal_connect_swapped(G_OBJECT(check[MSIDE6]), "activate",
	        G_CALLBACK(menu_nes_fds_select_side), GINT_TO_POINTER(6));
	g_signal_connect_swapped(G_OBJECT(check[MSIDE7]), "activate",
	        G_CALLBACK(menu_nes_fds_select_side), GINT_TO_POINTER(7));
	g_signal_connect_swapped(G_OBJECT(check[MSWITCH]), "activate",
	        G_CALLBACK(menu_nes_fds_select_side), GINT_TO_POINTER(0xFFF));
}

void menu_nes_fds_check(void) {
	if (fds.info.enabled) {
		BYTE i;

		if (fds.drive.disk_ejected) {
			gtk_menu_item_set_label(GTK_MENU_ITEM(check[MEJECT]), "Insert disk");
		} else {
			gtk_menu_item_set_label(GTK_MENU_ITEM(check[MEJECT]), "Eject disk");
		}

		gtk_widget_set_sensitive(check[MEJECT], TRUE);
		gtk_widget_set_sensitive(check[MSIDES], TRUE);

		for (i = 0; i < (MSIDE7 + 1) - MSIDE0; i++) {
			if (i < fds.info.total_sides) {
				gtk_widget_set_sensitive(check[MSIDE0 + i], TRUE);
			} else {
				gtk_widget_set_sensitive(check[MSIDE0 + i], FALSE);
			}
			if (i == fds.drive.side_inserted) {
				gtk_check_menu_item_set_active(GTK_CHECK_MENU_ITEM(check[MSIDE0 + i]), TRUE);
			} else {
				gtk_check_menu_item_set_active(GTK_CHECK_MENU_ITEM(check[MSIDE0 + i]), FALSE);
			}
		}
	} else {
		gtk_menu_item_set_label(GTK_MENU_ITEM(check[MEJECT]), "_Eject/_Insert disk");
		gtk_widget_set_sensitive(check[MEJECT], FALSE);
		gtk_widget_set_sensitive(check[MSIDES], FALSE);
	}
}
void menu_nes_fds_eject_insert_disk(void) {
	if (gui_in_update) {
		return;
	}

	if (!fds.drive.disk_ejected) {
		fds_disk_op(FDS_DISK_EJECT, 0);
	} else {
		fds_disk_op(FDS_DISK_INSERT, 0);
	}

	gui_update();
}
void menu_nes_fds_select_side(int side) {
	if (gui_in_update) {
		return;
	}

	if (side == 0xFFF) {
		side = fds.drive.side_inserted;
		if (++side >= fds.info.total_sides) {
			side = 0;
		}
	}

	if (fds.drive.side_inserted == side) {
		return;
	}

	fds_disk_op(FDS_DISK_SELECT, side);

	gui_update();
}
